<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>Orcid Connect</title>

	<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css"
      type="text/css"  />

	<link rel="shortcut icon" href="/favicon.ico?v=2" />

	<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
	<style>
	.glyphicon-spin {
    	-webkit-animation: spin 1000ms infinite linear;
    	animation: spin 1000ms infinite linear;
	}
	@-webkit-keyframes spin {
	  0% {
	    -webkit-transform: rotate(0deg);
	    transform: rotate(0deg);
	  }
	  100% {
	    -webkit-transform: rotate(359deg);
	    transform: rotate(359deg);
	  }
	}
	@keyframes spin {
	  0% {
	    -webkit-transform: rotate(0deg);
	    transform: rotate(0deg);
	  }
	  100% {
	    -webkit-transform: rotate(359deg);
	    transform: rotate(359deg);
	  }
	}	
	</style>
</head>
<body>

	<nav class="navbar navbar-default">
	  	<div class="container-fluid">
	    <!-- Brand and toggle get grouped for better mobile display -->
	    <div class="navbar-header">
	      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
	        <span class="sr-only">Toggle navigation</span>
	        <span class="icon-bar"></span>
	        <span class="icon-bar"></span>
	        <span class="icon-bar"></span>
	      </button>
	      <a class="navbar-brand" href="https://tutkijatunniste.wordpress.com">Tutkijatunniste</a>
	    </div>
	    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
	      <ul class="nav navbar-nav">
	        <li><a href="https://tutkijatunniste.wordpress.com/kansallinen-orcid-haka-yhdistamispalvelu/">Tietoa yhdistämispalvelusta</a></li>
	      </ul>
	      <ul class='nav navbar-nav pull-right'>
	    	<li id='logout' style='display: none;'><a href="/app/logout">Logout</a></li>
	    </ul>
	    </div>
	  </div>
	</nav>

	<div class="container-fluid">
	        <div class='row'>
		  <div class='col-md-offset-4 col-md-6 wellBox'>
		    <p class='well' id='initial' >Yhdistämispalvelussa tutkija voi liittää oman <a href='https://orcid.org'>ORCID</a>-tunnisteensa tutkimusorganisaatioon.
		    Löydät lisätietoa yhdistämispalvelusta <a href ='https://tutkijatunniste.wordpress.com/kansallinen-orcid-haka-yhdistamispalvelu/'>tästä linkistä</a>.
		    Tunnisteesi haetaan allaolevaan taulukkoon ensin omasta tutkimusorganisaatiostasi, jonka jälkeen voit kirjautua nykyisellä ORCID-tunnisteellasi
		    tai luoda uuden. Kun molemmat tunnisteet on haettu palveluun, voit toimittaa ne omaan organisatioosi hyväksyttyäsi tietojen välittämisen.
		    Aloita kirjautuminen valitsemalla oma organisaatiosi alla olevasta listasta.</p>
		    <p class='well' id='shibId' style='display: none'>Olet nyt kirjautunut oman tutkimusorganisaatiosi tunnuksella. Nyt voit kirjautua nykyisellä
		      ORCID-tunnusteellasi tai luoda uuden. Jos olet aiemmin luonut ORCID-tunnusteen, huomaa, että kirjautumislomake tulee näkyville klikkaamalla
		      ORCID:n sivun keskiosasta löytyvää 'Sign in'-linkkiä.</p>
		  </div>
		</div>

		<div class='row'>
		  <div class='col-md-offset-4 col-md-6'>
                    <script type="text/javascript" src="/ds/eds-conf.js"></script>
                    <script type="text/javascript" src="https://testsp.funet.fi/shibboleth/wayf.php/embedded-wayf.js"></script>
		  </div>
		</div>		

		<div class='row'>
			<div class="col-md-4">
				<ul id="mappings"></ul>
			</div>
			<div class="col-md-6">
				<div class="col-md-12">
					<table class="table">
						<tr><th></th><th>ORCID iD</th><th>Haka eppn</th></tr>
						<tr><th>Id</th>
							<td id="oauthId" style='display: none;'><a href='/app/orcidSandbox/signin' class='btn btn-default btn-signin' style='white-space: normal;' id='btnOrcid'>
								<img src="/img/orcid_24x24.png" alt="Sign in with ORCID"> Create or Connect your ORCID SANDBOX iD</a></td>
							<td id="hakaId"></td>
						<tr style='display: none;'><th>Nimi</th><td id="oauthName"></td><td id="hakaName"></td>
						</tr>
					</table>
				</div>
				<div id='confirmBlock' class='col-md-12' style='display: none;'>
					<div class='form-group'>
					<div class='checkbox'>
						<label><input id='acceptBox' type="checkbox">
						Hyväksyn tietojen lähettämisen kotiorganisaatiooni.
						Demopalvelussa on vasta kuvitteellisia palveluja,
						jotka vastaanottavat kuvittellisia tietoja.
						Älä käytä todellisia henkilötietoja.
						</input></label>
					</div>
					<button id='saveData' type='submit' class='btn btn-primary'>Tallenna</button>
					</div>
				</div>

			</div>
		</div>
		
	</div>
	
<script>

var isShibSessionBool;
var isOAuthSessionBool;

function getParameterByName(name) {
    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
    return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}

function fillEppn() {
	$.getJSON('/app/shib/user', function (jsonReply) {
		$("#hakaId").append(jsonReply.eppn);
	});
}

function checkBoth() {
	if (isShibSessionBool && isOAuthSessionBool) {
		$('#confirmBlock').toggle(true);
	}
}


function checkEither() {
	if (isShibSessionBool || isOAuthSessionBool) {
		$('#logout').toggle(true);
	}
}

function checkNeither() {
   if ((!isShibSessionBool) && (!isOAuthSessionBool)) {
   }
}

function check() {
	checkBoth();
	checkEither();
}

function isShibSession() {
	$.get("/Shibboleth.sso/Session", function(result) {
		var pattern = /[\s\S]*Authentication Time[\s\S]*/;
		isShibSessionBool = pattern.test(result);
		if (isShibSessionBool) {
			if (getParameterByName("logout") == "true") {
				window.location = "/Shibboleth.sso/Logout";
			} else {
			    //$('#hakaId').empty();
			    $('#oauthId').toggle(true);
			    $('#initial').toggle(false);
			    $('#shibId').toggle(true);
			    fillEppn();
			    check();
			}
		} else {
			$('#btnHaka').toggle(true);
			check();
		};
	});
}

$(function () {
	
	$.getJSON('/app/isAuthenticated', function (jsonReply) {
		if (jsonReply.isAuthenticated == "true") {
		    isOAuthSessionBool = true;
		    $('#oauthId').empty();
		    $.getJSON('/app/user', function (jsonReply) {
			$('#oauthId').append(
			    "<a href='http://sandbox.orcid.org/" + jsonReply.id + "'>" +
				"<img src='/favicon.ico'> " +
				"http://orcid.org/" + jsonReply.id + "</a>");
			$('#oauthName').append(jsonReply.name);
		    });
		    $.getJSON('/app/mappings', function (jsonReply) {
			var items = [];
			$.each(jsonReply, function(key, val) {
			    var str = val.substring(1, val.length);
			    items.push( "<li id='" + key + "'><a href='/app/" + str +
					"'>" + str + "</a></li>");
			});
			$('#mappings').empty();
			$('#mappings').append('<h4>Dev-linkkejä</h4>');
			$('#mappings').append( items.join( "" ));
			$('#logout').toggle(true);
		    });
		    check();
		} else {
			//$('#btnOrcid').toggle(true);
			check();
		}
	});
	isShibSession();
});

$('#saveData').on('click', function(event) {
	event.preventDefault();
	if ($('#acceptBox:checked').length > 0) {
		event.preventDefault();
		$.getJSON('/app/shib/trigpush', function (jsonReply) {
			console.out(jsonReply);
		});
	} else {
		alert("Tietojen lähettäminen ei onnistu ilman käyttäjän hyväksyntää.")
	}
});

</script>

</body>
</html>
