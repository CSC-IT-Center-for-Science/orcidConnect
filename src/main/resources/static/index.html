<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>Orcid Connect</title>

	<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css"
      type="text/css"  />

	<link rel="shortcut icon" href="/favicon.ico?v=2" />

	<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
	<style>
	.glyphicon-spin {
    	-webkit-animation: spin 1000ms infinite linear;
    	animation: spin 1000ms infinite linear;
	}
	@-webkit-keyframes spin {
	  0% {
	    -webkit-transform: rotate(0deg);
	    transform: rotate(0deg);
	  }
	  100% {
	    -webkit-transform: rotate(359deg);
	    transform: rotate(359deg);
	  }
	}
	@keyframes spin {
	  0% {
	    -webkit-transform: rotate(0deg);
	    transform: rotate(0deg);
	  }
	  100% {
	    -webkit-transform: rotate(359deg);
	    transform: rotate(359deg);
	  }
	}	
	</style>
</head>
<body>

	<nav class="navbar navbar-default">
	  	<div class="container-fluid">
	    <!-- Brand and toggle get grouped for better mobile display -->
	    <div class="navbar-header">
	      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
	        <span class="sr-only">Toggle navigation</span>
	        <span class="icon-bar"></span>
	        <span class="icon-bar"></span>
	        <span class="icon-bar"></span>
	      </button>
	      <a class="navbar-brand" href="/">Home</a>
	    </div>
	    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
	      <ul class="nav navbar-nav">
	        <li><a href="/">Link Template</a></li>
	      </ul>
	      <ul class='nav navbar-nav pull-right'>
	    	<li id='logout' style='display: none;'><a href="/app/logout">Logout</a></li>
	    </ul>
	    </div>
	  </div>
	</nav>

	<div class="container-fluid">
		<div class='row'>
			<div class="col-md-4">
				<ul id="mappings"></ul>
			</div>
			<div class="col-md-6">
				<div class="col-md-12">
					<table class="table">
						<tr><th></th><th>ORCID iD</th><th>Haka eppn</th></tr>
						<tr><th>Id</th>
							<td id="oauthId"><a href='/app/orcidSandbox/signin' class='btn btn-default btn-signin' style='display: none; white-space: normal;' id='btnOrcid'>
								<img src="/img/orcid_24x24.png" alt="Sign in with ORCID"> Create or Connect your ORCID SANDBOX iD</a></td>
							<td id="hakaId"><a href='/app/shib/signin' id='btnHaka' style='display: normal;'>
								<img src="/img/haka_landscape_large.gif" alt="Sign in with Haka" style='width: 90%;'> TEST</a></td>
						<tr style='display: none;'><th>Nimi</th><td id="oauthName"></td><td id="hakaName"></td>
						</tr>
					</table>
				</div>
				<div id='confirmBlock' class='col-md-12' style='display: none;'>
					<div class='form-group'>
					<div class='checkbox'>
						<label><input id='acceptBox' type="checkbox">Tämä demopalvelu ei vielä
						tallenna tietoja.
						Jos tämä olisi tuotantopalvelu, käyttäjän pitäisi
						hyväksyä, että tunnisteet tallennetaan
						ja luovutetaan kotiorganisaatiolle.</input></label>
					</div>
					<button id='saveData' type='submit' class='btn btn-primary'>Tallenna</button>
					</div>
				</div>

				<div class="col-md-6 wellBox" style='display: none; margin-top:4em;'>
					<p class='well'>ORCID provides a persistent digital identifier that distinguishes you from other researchers. Learn more at 
					<a href="http://orcid.org">orcid.org</a></p>
				</div>
				<div class="col-md-6 wellBox" style='display: none; margin-top:4em;'>
					<p class='well'>ORCID is an independent non-profit effort to provide an open registry of unique researcher identifiers and open
					 services to link research activities and organizations to these identifiers. Learn more at 
					 <a href="http://orcid.org">orcid.org</a>
				</div>

			</div>
		</div>
		
		<div class='row'>
			<div class='col-md-offset-4 col-md-6'>
				<button id='trigSoap' type='submit' class='btn btn-primary'>TrigSoap</button>
			</div>
		</div>
		
	</div>
	
<script>

var isShibSessionBool;
var isOAuthSessionBool;

function getParameterByName(name) {
    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
    return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}

function fillEppn() {
	$.getJSON('/app/shib/user', function (jsonReply) {
		$("#hakaId").append(jsonReply.eppn);
	});
}

function showWells() {
	$('.wellBox').toggle(true);
}

function checkBoth() {
	if (isShibSessionBool && isOAuthSessionBool) {
		$('#confirmBlock').toggle(true);
	}
}

function checkNeither() {
	if ((!isShibSessionBool) && (!isOAuthSessionBool)) {
		showWells();
	}
}

function checkEither() {
	if (isShibSessionBool || isOAuthSessionBool) {
		$('#logout').toggle(true);
	}
}

function check() {
	checkBoth();
	checkNeither();
	checkEither();
}

function isShibSession() {
	$.get("/Shibboleth.sso/Session", function(result) {
		var pattern = /[\s\S]*Authentication Time[\s\S]*/;
		isShibSessionBool = pattern.test(result);
		if (isShibSessionBool) {
			if (getParameterByName("logout") == "true") {
				window.location = "/Shibboleth.sso/Logout";
			} else {
				$('#hakaId').empty();
				fillEppn();
				check();
			}
		} else {
			$('#btnHaka').toggle(true);
			check();
		};
	});
}

$(function () {
	
	$.getJSON('/app/isAuthenticated', function (jsonReply) {
		if (jsonReply.isAuthenticated == "true") {
			isOAuthSessionBool = true;
			$.getJSON('/app/user', function (jsonReply) {
				$('#oauthId').append(
						"<a href='http://sandbox.orcid.org/" + jsonReply.id + "'>" +
						"<img src='/favicon.ico'> " +
						"http://orcid.org/" + jsonReply.id + "</a>");
				$('#oauthName').append(jsonReply.name);
			});
			/*$.getJSON('/app/mappings', function (jsonReply) {
				var items = [];
				$.each(jsonReply, function(key, val) {
					var str = val.substring(1, val.length);
					items.push( "<li id='" + key + "'><a href='/app/" + str +
							"'>" + str + "</a></li>");
				});
				$('#mappings').empty();
				$('#mappings').append('<h4>Dev-linkkejä</h4>');
				$('#mappings').append( items.join( "" ));
				$('#logout').toggle(true);
			});*/
			check();
		} else {
			$('#btnOrcid').toggle(true);
			check();
		}
	});
	isShibSession();
});

$('#saveData').on('click', function(event) {
	event.preventDefault();
	if ($('#acceptBox:checked').length > 0) {
		alert("Demopalvelu ei vielä tallenna tietoja");
	} else {
		alert("Jos tämä demo olisi tuotantokäytössä, tietojen tallentaminen pitäisi hyväksyä.")
	}
});

$('#trigSoap').on('click', function(event) {
	event.preventDefault();
	$.getJSON('/app/shib/trigsoap', function (jsonReply) {
		console.out(jsonReply);
	});
});

</script>

</body>
</html>